
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tolerant JSON parsing for iOS - Stewart Gleadow's Blog</title>
  <meta name="author" content="Stewart Gleadow">

  
  <meta name="description" content="Many useful iOS apps need to talk to some kind of backend web service. If you have any control over the back end, it will be talking JSON with your &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.stewgleadow.com/blog/2012/05/18/tolerant-json-parsing-for-ios">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Stewart Gleadow's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Stewart Gleadow's Blog</a></h1>
  
    <h2>My ramblings about iOS and other software topics.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.stewgleadow.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/about.html">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/talks.html">Talks</a></li>
  <li><a href="https://github.com/sgleadow">Code</a></li>
  <li><a href="http://twitter.com/stewgleadow">Twitter</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Tolerant JSON Parsing for iOS</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-18T09:38:00+10:00" pubdate data-updated="true">May 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Many useful iOS apps need to talk to some kind of backend web service. If you have any control over the back end, it will be talking JSON with your app. Each of these apps has some kind of JSON parsing behaviour. We&rsquo;ve had many debates on the merits of parsing the dictionary into our own plain old Objective C objects (POCOs) versus just passing around <code>NSDictionary</code> objects. I&rsquo;ll put on my best consultant voice and say &ldquo;it depends&rdquo;, let&rsquo;s not have that debate again today.</p>

<p>Either way, at some stage you need to be pulling values out of an NSDictionary, and you want to do so safely. Martin Fowler wrote a few years ago about the <a href="http://martinfowler.com/bliki/TolerantReader.html">tolerant reader</a> approach, in which he says:</p>

<blockquote><p><em>&ldquo;My recommendation is to be as tolerant as possible when reading data from a service. If you&rsquo;re consuming an XML file, then only take the elements you need, ignore anything you don&rsquo;t.&rdquo;</em></p></blockquote>

<h2>Simple mapping of NSDictionary to properties</h2>

<p>Let&rsquo;s say we have the following JSON to represent a person:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;stew&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;role&quot;</span> <span class="o">:</span> <span class="s2">&quot;developer&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;level&quot;</span> <span class="o">:</span> <span class="s2">&quot;awesome&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>NSDictionary has some simple KVC methods we can use to pull out the keys we want to map them to the properties on our person class. The properties are <code>name</code>, <code>role</code>, <code>level</code>, all of which are of type <code>NSString *</code> for simplicity. Something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict</span> <span class="nl">valueForKey:</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict</span> <span class="nl">valueForKey:</span><span class="s">@&quot;role&quot;</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict</span> <span class="nl">valueForKey:</span><span class="s">@&quot;level&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Dynamic mapping of NSDictionary to properties</h2>

<p>That kind of works, it grabs the right keys&hellip; but the developer in you thinks, hey, that seems pretty repeatable. I bet I could make that dynamic so as I add more data to the <code>NSDictionary</code>, new properties on my <code>Person</code> object are automatically populated. There are frameworks that do that kind of stuff for you, but a simple version could look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">dict</span> <span class="nl">enumerateKeysAndObjectsUsingBlock:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">key</span><span class="p">,</span> <span class="kt">id</span> <span class="n">obj</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">setValue:</span><span class="n">obj</span> <span class="nl">forKey:</span><span class="n">key</span><span class="p">];</span>
</span><span class='line'><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome. Less code is better, right?</p>

<h2>Take only the elements you need</h2>

<p>The problem with dynamically mapping data from a web service is that it assumes that the JSON data pulled down exactly matches what is expected, and never changes. If you so much as add a new data element to the JSON coming from the server, the app with break with an exception like <code>raised [&lt;Person 0xe328ce0&gt; setValue:forUndefinedKey:]: this class is not key value coding-compliant for the key new-key.</code></p>

<p>Now, even if you control both the client and the server, you want have a bit more flexibility than that. Sure, you could version the API and make it clever enough to serve the right data, but creating new API versions every time you add a new field is a bit of overhead. It&rsquo;s better to <em>&ldquo;take only the elements you need&rdquo;</em>, then you can add new data as much as you want.</p>

<p>So you ditch the dynamic approach, it saves a few lines of Objective C but creates more problems elsewhere. We&rsquo;re back with the explicit dictionary-to-property mapping, which at least gives us the flexibility to add new data to the API and our iOS app just ignores the extra data.</p>

<h2>Be as tolerant as possible</h2>

<p>The issue we still have with our <em>valueForKey</em> approach is that we are assuming that the API is giving us back the correct data for each key. Objective C is pretty dynamic, so we just grab the value out of the dictionary and set it on the properties, which are NSString types. If, for some reason, the API starts returning a different type for the <em>level</em>. Maybe they&rsquo;ve decided the level is now the number 11 and not a string, or maybe they&rsquo;ve introduced a more complex representation of the level as a dictionary with extra keys, for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;stew&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;role&quot;</span> <span class="o">:</span> <span class="s2">&quot;developer&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;level&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;awesome&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span> <span class="o">:</span> <span class="mi">5</span><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The actual parsing code still works fine. At runtime, Objective C will grab that dictionary for the <em>level</em> and shove it into the NSString. Now, everywhere else in our code will make the assumption that <code>person.level</code> will give back an NSString, and so it should &ndash; but when we start to call methods on this property that are specific to NSString, we&rsquo;re going to get some strange errors. Say you had some code looking at the prefix of the level property:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">level</span> <span class="o">=</span> <span class="n">person</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">([</span><span class="n">level</span> <span class="nl">hasPrefix:</span><span class="s">@&quot;awesome&quot;</span><span class="p">])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// do something for awesome people</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Try running that and you&rsquo;ll get an error like <code>[__NSCFDictionary hasPrefix:]: unrecognized selector sent to instance</code>. So what we really want is to be tolerant of receiving incorrect data back when you are parsing it. We&rsquo;re already ignoring extra data, now we also want to ignore data that is of the incorrect type.</p>

<h2>Safe dictionary extraction</h2>

<p>On a number of projects now I&rsquo;ve use a little category on NSDictionary that does this type checking for me, and also allows for feeding in a default value if the data is missing. In practice I don&rsquo;t usually feed in a default value, I like the properties to end up being <em>nil</em> if the data doesn&rsquo;t come back in the expected format. In the instance where I want to display certain values in the UI to show data is missing, that&rsquo;s UI logic and doesn&rsquo;t really belong in the data parsing in my opinion.</p>

<p>A short and sweet implementation of this safe NSDictionary category could be something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@implementation</span> <span class="nc">NSDictionary</span> <span class="nl">(SafeAccess)</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">valueForKey:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">key</span>
</span><span class='line'>         <span class="nf">ifKindOf:</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="nv">class</span>
</span><span class='line'>     <span class="nf">defaultValue:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">defaultValue</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">id</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">objectForKey:</span><span class="n">key</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">obj</span> <span class="nl">isKindOfClass:</span><span class="n">class</span><span class="p">]</span> <span class="o">?</span> <span class="n">obj</span> <span class="o">:</span> <span class="n">defaultValue</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our parsing code might then end up looking more like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict</span> <span class="nl">valueForKey:</span><span class="s">@&quot;name&quot;</span> <span class="nl">ifKindOf:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">class</span><span class="p">]</span> <span class="nl">defaultValue:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict</span> <span class="nl">valueForKey:</span><span class="s">@&quot;role&quot;</span> <span class="nl">ifKindOf:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">class</span><span class="p">]</span> <span class="nl">defaultValue:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict</span> <span class="nl">valueForKey:</span><span class="s">@&quot;level&quot;</span> <span class="nl">ifKindOf:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">class</span><span class="p">]</span> <span class="nl">defaultValue:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it. Pretty simple. Credit should be given to <a href="http://twitter.com/#!/kevinoneill">Kevin O&#8217;Neill</a> who originally introduced this method, and has a more complete implementation in his <a href="https://github.com/kevinoneill/Useful-Bits">Useful Bits github project</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Stewart Gleadow</span></span>

      








  


<time datetime="2012-05-18T09:38:00+10:00" pubdate data-updated="true">May 18<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ios/'>ios</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.stewgleadow.com/blog/2012/05/18/tolerant-json-parsing-for-ios/" data-via="stewgleadow" data-counturl="http://www.stewgleadow.com/blog/2012/05/18/tolerant-json-parsing-for-ios/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/03/03/installing-imagemagick-on-lion/" title="Previous Post: Installing ImageMagick on Lion">&laquo; Installing ImageMagick on Lion</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/07/02/getting-started-with-ios-development/" title="Next Post: Getting started with iOS development">Getting started with iOS development &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/02/getting-started-with-ios-development/">Getting Started With iOS Development</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/18/tolerant-json-parsing-for-ios/">Tolerant JSON Parsing for iOS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/03/installing-imagemagick-on-lion/">Installing ImageMagick on Lion</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/09/running-ocunit-and-kiwi-tests-on-the-command-line/">Running OCUnit &amp; Kiwi Tests on the Command Line</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/10/installing-rvm-on-os-x-lion/">Installing RVM on OS X Lion</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sgleadow">@sgleadow</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sgleadow',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Stewart Gleadow -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sgleadow-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.stewgleadow.com/blog/2012/05/18/tolerant-json-parsing-for-ios/';
        var disqus_url = 'http://www.stewgleadow.com/blog/2012/05/18/tolerant-json-parsing-for-ios/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
